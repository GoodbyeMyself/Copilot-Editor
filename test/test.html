<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco Diff Editor with Accept Buttons Demo (Fixed)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #container {
            width: 90vw;
            height: 80vh;
            border: 1px solid #ccc;
        }

        /* 自定义按钮公共样式 */
        .accept-button, .reject-button {
            border: none;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
            position: relative;
            z-index: 1001;
            font-size: 10px;
            padding: 4px 8px;
            color: white;
            height: 24px;
            line-height: 18px;
        }

        /* 接受按钮样式 */
        .accept-button {
            background-color: #2c8c3e;
        }

        .accept-button:hover {
            opacity: 1;
            background-color: #228c36;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        /* 拒绝按钮样式 */
        .reject-button {
            background-color: rgb(52, 54, 55);
        }

        .reject-button:hover {
            opacity: 1;
            background-color: #c82333;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>

<body>

    <h1>Monaco Inline Diff Editor + IOverlayWidget Demo (Fixed)</h1>
    <p>点击每个绿色或红色变更块右上角的 "✓ Accept" 按钮来接受更改。</p>

    <div id="container"></div>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>
    <script>
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            // 原始代码
            const originalText = [
                'function hello() {',
                '\tconsole.log("Hello, world!");',
                '}',
                '',
                'function goodbye() {',
                '\tconsole.log("Goodbye, world!");',
                '}'
            ].join('\n');

            // 修改后的代码
            const modifiedText = [
                'function hello(name) {',
                '\tconsole.log(`Hello, ${name}!`);',
                '}',
                '',
                '// function goodbye() was here',
                '',
                'function greet() {',
                '\tconsole.log("Greetings!");',
                '}'
            ].join('\n');

            const originalModel = monaco.editor.createModel(originalText, 'javascript');
            const modifiedModel = monaco.editor.createModel(modifiedText, 'javascript');

            const diffEditor = monaco.editor.createDiffEditor(document.getElementById('container'), {
                originalEditable: true,
                readOnly: false,
                renderSideBySide: false,
                theme: 'monokai',
                // 启用右侧代码地图
                minimap: {
                    enabled: true,
                    side: 'right',
                    size: 'proportional',
                    showSlider: 'mouseover',
                    renderCharacters: true,
                    maxColumn: 120,
                    scale: 1
                },
                // 其他有用的选项
                scrollBeyondLastLine: false,
                automaticLayout: true,
                wordWrap: 'on'
            });

            diffEditor.setModel({
                original: originalModel,
                modified: modifiedModel
            });

            let activeDecorations = [];
            let buttonContainers = new Map(); // 使用Map存储按钮容器

            function createAcceptButtons() {
                const lineChanges = diffEditor.getLineChanges();
                if (!lineChanges) {
                    // 如果没有差异，清除所有按钮
                    clearAllButtons();
                    return;
                }

                // 获取当前差异块的唯一标识
                const currentChanges = lineChanges.map(change => getChangeKey(change));
                
                // 移除不再存在的差异块对应的按钮
                for (let [key, container] of buttonContainers) {
                    if (!currentChanges.includes(key)) {
                        removeButtonContainer(key);
                    }
                }

                // 为新的差异块创建按钮
                lineChanges.forEach((change, index) => {
                    if (change.modifiedEndLineNumber === 0 && change.originalEndLineNumber === 0) {
                        return;
                    }

                    const changeKey = getChangeKey(change);
                    
                    // 如果这个差异块还没有按钮，创建新的
                    if (!buttonContainers.has(changeKey)) {
                        setTimeout(() => {
                            createButtonForChange(changeKey, change, index);
                        }, 50);
                    } else {
                        // 如果按钮已存在，更新位置
                        setTimeout(() => {
                            updateButtonPosition(changeKey, change);
                        }, 50);
                    }
                });
            }

            function getChangeKey(change) {
                // 为每个差异块生成唯一标识
                return `${change.originalStartLineNumber}-${change.originalEndLineNumber}-${change.modifiedStartLineNumber}-${change.modifiedEndLineNumber}`;
            }

            function clearAllButtons() {
                buttonContainers.forEach((container, key) => {
                    removeButtonContainer(key);
                });
            }

            function removeButtonContainer(key) {
                const container = buttonContainers.get(key);
                if (container && container.parentNode) {
                    container.parentNode.removeChild(container);
                }
                buttonContainers.delete(key);
            }

            function createButtonForChange(changeKey, change, index) {
                // 计算差异块的结束行
                let targetLine;
                if (change.modifiedEndLineNumber > 0) {
                    targetLine = change.modifiedEndLineNumber;
                } else {
                    targetLine = change.originalStartLineNumber;
                }
                
                if (targetLine === 0) return;

                const editor = diffEditor.getModifiedEditor();
                const editorContainer = editor.getDomNode();
                
                if (!editorContainer) return;

                // 创建悬浮按钮容器
                const buttonContainer = document.createElement('div');
                buttonContainer.style.position = 'absolute';
                buttonContainer.style.zIndex = '1000';
                buttonContainer.style.pointerEvents = 'auto';
                buttonContainer.style.right = '14px';

                // 创建拒绝按钮
                const rejectButton = document.createElement('button');
                rejectButton.className = 'reject-button floating-reject-button';
                rejectButton.innerHTML = '✗ Reject';
                
                rejectButton.onclick = (e) => {
                    e.stopPropagation();
                    // 立即移除当前按钮
                    removeButtonContainer(changeKey);
                    rejectChange(change);
                    // 短暂延时后更新剩余按钮位置
                    setTimeout(() => createAcceptButtons(), 100);
                };

                // 创建接受按钮
                const acceptButton = document.createElement('button');
                acceptButton.className = 'accept-button floating-accept-button';
                acceptButton.innerHTML = '✓ Accept';
                
                acceptButton.onclick = (e) => {
                    e.stopPropagation();
                    // 立即移除当前按钮
                    removeButtonContainer(changeKey);
                    applyChange(change);
                    // 短暂延时后更新剩余按钮位置
                    setTimeout(() => createAcceptButtons(), 100);
                };

                buttonContainer.appendChild(rejectButton);
                buttonContainer.appendChild(acceptButton);
                
                // 将悬浮按钮添加到编辑器容器中
                editorContainer.style.position = 'relative';
                editorContainer.appendChild(buttonContainer);
                
                // 存储按钮容器
                buttonContainers.set(changeKey, buttonContainer);
                
                // 更新按钮位置
                updateButtonPosition(changeKey, change);
            }

            function updateButtonPosition(changeKey, change) {
                const buttonContainer = buttonContainers.get(changeKey);
                if (!buttonContainer) return;

                // 计算差异块的结束行
                let targetLine;
                if (change.modifiedEndLineNumber > 0) {
                    targetLine = change.modifiedEndLineNumber;
                } else {
                    targetLine = change.originalStartLineNumber;
                }

                const editor = diffEditor.getModifiedEditor();
                
                // 获取行的屏幕位置
                const position = editor.getScrolledVisiblePosition({
                    lineNumber: targetLine,
                    column: 1
                });

                if (position) {
                    const editorContainer = editor.getDomNode();
                    const editorRect = editorContainer.getBoundingClientRect();
                    buttonContainer.style.top = `${position.top + 20}px`; // 行下方20px
                }
            }

            function applyChange(change) {
                const modifiedEditor = diffEditor.getModifiedEditor();
                const originalEditor = diffEditor.getOriginalEditor();

                let newText = "";
                if (change.modifiedEndLineNumber > 0) {
                    const modifiedRange = new monaco.Range(change.modifiedStartLineNumber, 1, change.modifiedEndLineNumber, modifiedEditor.getModel().getLineMaxColumn(change.modifiedEndLineNumber));
                    newText = modifiedEditor.getModel().getValueInRange(modifiedRange);
                }

                // 如果新文本不是以换行符结尾，并且它不是文件的最后一部分，则可能需要添加一个
                // （这是一个高级用例，这里我们保持简单）

                const originalRange = change.originalEndLineNumber > 0
                    ? new monaco.Range(change.originalStartLineNumber, 1, change.originalEndLineNumber, originalEditor.getModel().getLineMaxColumn(change.originalEndLineNumber))
                    : new monaco.Range(change.originalStartLineNumber, 1, change.originalStartLineNumber, 1);

                originalModel.pushEditOperations(
                    [],
                    [{
                        range: originalRange,
                        text: newText
                    }],
                    () => null
                );

                // 强制刷新diff视图
                setTimeout(() => {
                    diffEditor.updateOptions({});
                }, 50);
            }

            function rejectChange(change) {
                const modifiedEditor = diffEditor.getModifiedEditor();
                const originalEditor = diffEditor.getOriginalEditor();

                // 拒绝操作：参考接受按钮的逻辑，做反向操作
                // 从原始编辑器获取文本，应用到修改后的编辑器中
                
                let originalText = "";
                if (change.originalEndLineNumber > 0) {
                    const originalRange = new monaco.Range(change.originalStartLineNumber, 1, change.originalEndLineNumber, originalEditor.getModel().getLineMaxColumn(change.originalEndLineNumber));
                    originalText = originalEditor.getModel().getValueInRange(originalRange);
                }

                // 如果原始文本不是以换行符结尾，并且它不是文件的最后一部分，则可能需要添加一个
                // （这是一个高级用例，这里我们保持简单）

                const modifiedRange = change.modifiedEndLineNumber > 0
                    ? new monaco.Range(change.modifiedStartLineNumber, 1, change.modifiedEndLineNumber, modifiedEditor.getModel().getLineMaxColumn(change.modifiedEndLineNumber))
                    : new monaco.Range(change.modifiedStartLineNumber, 1, change.modifiedStartLineNumber, 1);

                modifiedModel.pushEditOperations(
                    [],
                    [{
                        range: modifiedRange,
                        text: originalText
                    }],
                    () => null
                );

                // 强制刷新diff视图
                setTimeout(() => {
                    diffEditor.updateOptions({});
                }, 50);
            }

            // 监听各种事件来重新创建按钮
            diffEditor.onDidUpdateDiff(createAcceptButtons);
            
            // 监听滚动事件
            diffEditor.getModifiedEditor().onDidScrollChange(() => {
                setTimeout(createAcceptButtons, 50);
            });
            
            // 监听内容变化
            diffEditor.getModifiedEditor().onDidChangeModelContent(() => {
                setTimeout(createAcceptButtons, 50);
            });
            
            // 监听视图变化
            diffEditor.getModifiedEditor().onDidLayoutChange(() => {
                setTimeout(createAcceptButtons, 50);
            });
            
            createAcceptButtons();
        });
    </script>
</body>

</html>