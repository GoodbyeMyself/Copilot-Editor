<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monaco Diff Editor with Accept Buttons Demo (Fixed)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #container {
            width: 90vw;
            height: 80vh;
            border: 1px solid #ccc;
        }

        /* 自定义按钮公共样式 */
        .accept-button, .reject-button {
            border: none;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
            position: relative;
            z-index: 1001;
            font-size: 10px;
            padding: 4px 8px;
            color: white;
            height: 24px;
            line-height: 18px;
        }

        /* 接受按钮样式 */
        .accept-button {
            background-color: #2c8c3e;
        }

        .accept-button:hover {
            opacity: 1;
            background-color: #228c36;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        /* 拒绝按钮样式 */
        .reject-button {
            background-color: rgb(52, 54, 55);
        }

        .reject-button:hover {
            opacity: 1;
            background-color: #c82333;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>

<body>

    <h1>Monaco Inline Diff Editor + IOverlayWidget Demo (Fixed)</h1>
    <p>点击每个绿色或红色变更块右上角的 "✓ Accept" 按钮来接受更改。</p>

    <div id="container"></div>

    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script>
    <script>
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            // 原始代码
            const originalText = [
                'function hello() {',
                '\tconsole.log("Hello, world!");',
                '}',
                '',
                'function goodbye() {',
                '\tconsole.log("Goodbye, world!");',
                '}'
            ].join('\n');

            // 修改后的代码
            const modifiedText = [
                'function hello(name) {',
                '\tconsole.log(`Hello, ${name}!`);',
                '}',
                '',
                '// function goodbye() was here',
                '',
                'function greet() {',
                '\tconsole.log("Greetings!");',
                '}'
            ].join('\n');

            const originalModel = monaco.editor.createModel(originalText, 'javascript');
            const modifiedModel = monaco.editor.createModel(modifiedText, 'javascript');

            const diffEditor = monaco.editor.createDiffEditor(document.getElementById('container'), {
                originalEditable: true,
                readOnly: false,
                renderSideBySide: false,
                theme: 'monokai',
                // 启用右侧代码地图
                minimap: {
                    enabled: true,
                    side: 'right',
                    size: 'proportional',
                    showSlider: 'mouseover',
                    renderCharacters: true,
                    maxColumn: 120,
                    scale: 1
                },
                // 其他有用的选项
                scrollBeyondLastLine: false,
                automaticLayout: true,
                wordWrap: 'on'
            });

            diffEditor.setModel({
                original: originalModel,
                modified: modifiedModel
            });

            let activeDecorations = [];

            function createAcceptButtons() {
                // 清除之前的装饰
                if (activeDecorations.length > 0) {
                    activeDecorations = diffEditor.getModifiedEditor().deltaDecorations(activeDecorations, []);
                }

                // 清除之前的悬浮按钮
                const existingButtons = document.querySelectorAll('[id^="floating-button-"]');
                existingButtons.forEach(button => button.remove());

                const lineChanges = diffEditor.getLineChanges();
                if (!lineChanges) return;

                const decorations = [];

                lineChanges.forEach((change, index) => {
                    if (change.modifiedEndLineNumber === 0 && change.originalEndLineNumber === 0) {
                        return;
                    }

                    // 计算差异块的结束行
                    let targetLine;
                    if (change.modifiedEndLineNumber > 0) {
                        targetLine = change.modifiedEndLineNumber;
                    } else {
                        targetLine = change.originalStartLineNumber;
                    }
                    
                    if (targetLine === 0) return;

                    // 标记差异块的范围用于定位
                    decorations.push({
                        range: new monaco.Range(targetLine, 1, targetLine, 1),
                        options: {
                            className: `diff-block-marker-${index}`,
                            stickiness: monaco.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges
                        }
                    });

                    // 创建对应的CSS和按钮
                    setTimeout(() => {
                        createInlineButton(index, change);
                    }, 50);
                });

                // 应用装饰
                activeDecorations = diffEditor.getModifiedEditor().deltaDecorations([], decorations);
            }

            function createInlineButton(index, change) {
                const markerClassName = `diff-block-marker-${index}`;
                
                // 使用延时等待Monaco Editor完成DOM更新
                const checkAndCreateButton = () => {
                    const markerElements = document.querySelectorAll(`.${markerClassName}`);
                    
                    markerElements.forEach(markerElement => {
                        // 检查是否已经有悬浮按钮，避免重复创建
                        const existingButton = document.getElementById(`floating-button-${index}`);
                        if (existingButton) {
                            existingButton.remove();
                        }

                        // 获取标记元素的位置
                        const rect = markerElement.getBoundingClientRect();
                        const editorContainer = diffEditor.getModifiedEditor().getDomNode();
                        const editorRect = editorContainer.getBoundingClientRect();
                        
                        // 创建悬浮按钮容器
                        const buttonContainer = document.createElement('div');
                        buttonContainer.id = `floating-button-${index}`;
                        buttonContainer.style.position = 'absolute';
                        buttonContainer.style.zIndex = '1000';
                        buttonContainer.style.pointerEvents = 'auto';
                        
                        // 定位在行的下方右侧
                        const lineHeight = diffEditor.getModifiedEditor().getOption(monaco.editor.EditorOption.lineHeight);
                        buttonContainer.style.right = `${14}px`;
                        buttonContainer.style.top = `${rect.bottom - editorRect.top}px`;

                        // 创建拒绝按钮
                        const rejectButton = document.createElement('button');
                        rejectButton.className = 'reject-button floating-reject-button';
                        rejectButton.innerHTML = '✗ Reject';
                        
                        rejectButton.onclick = (e) => {
                            e.stopPropagation();
                            // 立即隐藏当前按钮组
                            buttonContainer.style.display = 'none';
                            rejectChange(change);
                            // 延时重新创建按钮，确保差异更新完成
                            setTimeout(() => createAcceptButtons(), 100);
                        };

                        // 创建接受按钮
                        const acceptButton = document.createElement('button');
                        acceptButton.className = 'accept-button floating-accept-button';
                        acceptButton.innerHTML = '✓ Accept';
                        
                        acceptButton.onclick = (e) => {
                            e.stopPropagation();
                            // 立即隐藏当前按钮组
                            buttonContainer.style.display = 'none';
                            applyChange(change);
                            // 延时重新创建按钮，确保差异更新完成
                            setTimeout(() => createAcceptButtons(), 100);
                        };

                        buttonContainer.appendChild(rejectButton);
                        buttonContainer.appendChild(acceptButton);
                        
                        // 将悬浮按钮添加到编辑器容器中
                        editorContainer.style.position = 'relative';
                        editorContainer.appendChild(buttonContainer);
                    });
                };

                // 多次检查确保按钮被创建
                setTimeout(checkAndCreateButton, 50);
                setTimeout(checkAndCreateButton, 150);
                setTimeout(checkAndCreateButton, 300);
            }

            function applyChange(change) {
                const modifiedEditor = diffEditor.getModifiedEditor();
                const originalEditor = diffEditor.getOriginalEditor();

                let newText = "";
                if (change.modifiedEndLineNumber > 0) {
                    const modifiedRange = new monaco.Range(change.modifiedStartLineNumber, 1, change.modifiedEndLineNumber, modifiedEditor.getModel().getLineMaxColumn(change.modifiedEndLineNumber));
                    newText = modifiedEditor.getModel().getValueInRange(modifiedRange);
                }

                // 如果新文本不是以换行符结尾，并且它不是文件的最后一部分，则可能需要添加一个
                // （这是一个高级用例，这里我们保持简单）

                const originalRange = change.originalEndLineNumber > 0
                    ? new monaco.Range(change.originalStartLineNumber, 1, change.originalEndLineNumber, originalEditor.getModel().getLineMaxColumn(change.originalEndLineNumber))
                    : new monaco.Range(change.originalStartLineNumber, 1, change.originalStartLineNumber, 1);

                originalModel.pushEditOperations(
                    [],
                    [{
                        range: originalRange,
                        text: newText
                    }],
                    () => null
                );

                // 强制刷新diff视图
                setTimeout(() => {
                    diffEditor.updateOptions({});
                }, 50);
            }

            function rejectChange(change) {
                const modifiedEditor = diffEditor.getModifiedEditor();
                const originalEditor = diffEditor.getOriginalEditor();

                // 获取原始文本
                let originalText = "";
                if (change.originalEndLineNumber > 0) {
                    const originalRange = new monaco.Range(change.originalStartLineNumber, 1, change.originalEndLineNumber, originalEditor.getModel().getLineMaxColumn(change.originalEndLineNumber));
                    originalText = originalEditor.getModel().getValueInRange(originalRange);
                }

                // 将修改后的文本恢复为原始文本
                const modifiedRange = change.modifiedEndLineNumber > 0
                    ? new monaco.Range(change.modifiedStartLineNumber, 1, change.modifiedEndLineNumber, modifiedEditor.getModel().getLineMaxColumn(change.modifiedEndLineNumber))
                    : new monaco.Range(change.modifiedStartLineNumber, 1, change.modifiedStartLineNumber, 1);

                modifiedModel.pushEditOperations(
                    [],
                    [{
                        range: modifiedRange,
                        text: originalText
                    }],
                    () => null
                );

                // 强制刷新diff视图
                setTimeout(() => {
                    diffEditor.updateOptions({});
                }, 50);
            }

            // 监听各种事件来重新创建按钮
            diffEditor.onDidUpdateDiff(createAcceptButtons);
            
            // 监听滚动事件
            diffEditor.getModifiedEditor().onDidScrollChange(() => {
                setTimeout(createAcceptButtons, 50);
            });
            
            // 监听内容变化
            diffEditor.getModifiedEditor().onDidChangeModelContent(() => {
                setTimeout(createAcceptButtons, 50);
            });
            
            // 监听视图变化
            diffEditor.getModifiedEditor().onDidLayoutChange(() => {
                setTimeout(createAcceptButtons, 50);
            });
            
            createAcceptButtons();
        });
    </script>
</body>

</html>